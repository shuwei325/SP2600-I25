---
title: 'Tema 1: Análisis espectral de series temporales-2'
subtitle: 'Curso: Tópicos Avanzados de Series Temporales'
format: clean-revealjs
html-math-method:
  method: mathjax
  url: "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
author:
  - name: Shu Wei Chou Chen
    #orcid: 0000-0001-5495-2486
    email: shuwei.chou@ucr.ac.cr
    affiliations: Escuela de Estadística, Universidad de Costa Rica
#date: last-modified
lang: es  # español
---


```{r, include=FALSE}
library(ggplot2)
library(forecast)
library(fpp2)
library(astsa)
library(tidyverse)
library(TSA)
```


## Contenido

1. Introducción
2. Ejemplos de motivación
3. Comportamiento cíclico y periodicidad.
4. Estimación y periodograma.

 
## Introducción

- Hasta el momento hemos centrado el análisis de series temporales en el **dominio de tiempo**.
- Vamos a enfocar el estudio de series temporales en el **dominio de frecuencias**.
- Es decir, expresar las características de las series en término de las variaciones periódicas.
- Por ejemplo, 
  - para datos trimestrales que presentan un ciclo por año, i.e. periodicidad de 4, o $\omega=0.25$ ciclos por observación.
  - para datos mensuales que presentan un ciclo por año, i.e. periodicidad de 12, o $\omega=1/12=0.083$ ciclos por observación.
- Existen muchas escalas de frecuencia.
- Nosotros vamos a utilizar la frecuencia como $\omega$. Alternativamente, se puede definir $\lambda=2 \pi \omega$, que está dado por radianes por observación.

 
## Ejemplo 1: pasajeros

- La base de datos "AirPassenger" en R proporciona total de pasajeros mensuales de una aerolínea estadounidense de 1949 a 1960. 

```{r echo=FALSE, out.width = "35%", fig.align="center"}
data(AirPassengers)
autoplot(AirPassengers)
```

- En este caso, la periodicidad dominante de esta serie es $1/\omega=12$ periodos por ciclo, o la frecuencia dominante es $\omega=0.083$.

- ¿Hay alguna manera formal de detectar esta periodicidad?


 
## Ejemplo 1: pasajeros

- Aplicamos el logarítmo para estabilizar la variabilidad y quitamos la tendencia lineal de los datos. 

```{r echo=FALSE, out.width = "30%"}
autoplot(log(AirPassengers))+ 
  geom_smooth(method='lm', formula= y~x)
mod<-tslm(log(AirPassengers)~trend)
autoplot(mod$residuals)
autoplot(acf(mod$residuals,lag.max=50,plot=FALSE))
```


- Note que la ACF nos da indicación de que al quitar la tendencia, puede haber periodicidad de 12 meses.



 
## Ejemplo 1: pasajeros

**Periodograma:**

```{r echo=FALSE, out.width = "40%", fig.align="center"}
turista.per = mvspec(mod$residuals) 
```

 
## Ejemplo 2: Corriente de rio

- El flujo mensual del rio de Iowa medido en Wapello, Iowa de septiembre 1958 a agosto 2006.

```{r echo=FALSE, out.width = "30%"}
data(flow)
autoplot(flow,ylab='River Flow')
autoplot(acf(flow,lag.max=50,plot=FALSE))
rio.per = mvspec(flow) 
```

 
## Ejemplo 3: Producción de leche

- Producción de leche promedio por vaca en Estados Unidos de enero 1994 a diciembre 2005.

:::: {.columns}

::: {.column width="50%"}
```{r echo=FALSE, out.width = "50%", fig.align="center"}
data(milk)
autoplot(milk)+ 
  geom_smooth(method='lm', formula= y~x)
mod<-tslm(milk~trend)
autoplot(mod$residuals)
```
:::

::: {.column width="50%"}
```{r echo=FALSE, out.width = "50%", fig.align="center"}
autoplot(acf(mod$residuals,lag.max=50,plot=FALSE))
milk.per = mvspec(mod$residuals) 
```
:::
::::


 
## Comportamiento cíclico y periodicidad


:::: {.columns}

::: {.column width="50%"}

- Considere $x_t=2 \cos \left( 2 \pi \frac{t+15}{50} \right)+ w_t$ para $t=1,...,500$.

- El modelo general $A cos(2\pi \omega t + \phi)$ con amplitud $A$, frecuencia $\omega$, y fase $\phi$.

- El ejemplo anterior considera $A=2$, $\omega=1/50$ (un ciclo cada 50 puntos en el tiempo) y $\phi=2 \pi 15/50=0.6 \pi$.

:::

::: {.column width="50%"}
```{r echo=FALSE, fig.align="center", out.width = "100%"}
cs = 2*cos(2*pi*1:500/50 + .6*pi); w = rnorm(500,0,1)
par(mfrow=c(3,1), mar=c(3,2,2,1), cex.main=1.5)
plot.ts(cs, main=expression(2*cos(2*pi*t/50+.6*pi)))
plot.ts(cs+w, main=expression(2*cos(2*pi*t/50+.6*pi) + N(0,1)))
plot.ts(cs+5*w, main=expression(2*cos(2*pi*t/50+.6*pi) + N(0,25)))
```
:::
::::


 
## Comportamiento cíclico y periodicidad

- Ahora considere el modelo: 
$$x_t=A cos(2\pi \omega t + \phi)$$ 
con amplitud $A$, frecuencia $\omega$, y fase $\phi$ (que determina dónde inicia la función coseno).

- Usando la identidad trigonométrica $cos(\alpha\pm\beta)=cos(\alpha)cos(\beta)\mp sin(\alpha)sin(\beta)$, se puede reescribir el modelo como:
$$x_t=U_1 cos(2\pi \omega t )+U_2 sin(2\pi \omega t ),$$
donde $U_1=A cos\phi$ y $U_2=-A sin\phi$.


 
## Comportamiento cíclico y periodicidad

- Vamos a concentrar en este modelo:

$$x_t=U_1 cos(2\pi \omega t )+U_2 sin(2\pi \omega t ),$$
donde $U_1=A cos\phi$ y $U_2=-A sin\phi$.



- Suponga que $U_1$ y $U_2$ son variables aleatorias no correlacionadas con media $0$ y variancia $\sigma^2$. Se puede comprobar que el proceso estocástico $x_t$ es estacionario con media $0$ y su función de autocovariancia es dada por:

$$\gamma_X(h)=Cov(x_{t+h},x_t)=\sigma^2 cos(2 \pi \omega h).$$
- Note que $Var(x_t)=\gamma_X(0)=\sigma^2$.

 
## Comportamiento cíclico y periodicidad

- Note que el modelo
$$x_t=U_1 cos(2\pi \omega t )+U_2 sin(2\pi \omega t ),$$
es función de su frecuencia, $\omega$.

- Si $\omega=1$, la serie realiza un ciclo cada unidad de tiempo.
- Si $\omega=0.5$, la serie realiza un ciclo cada 2 unidades de tiempo.
- Si $\omega=0.25$, la serie realiza un ciclo cada 4 unidades de tiempo.

- En la práctica, al observar tiempos discretos, necesitamos por lo menos 2 puntos para determinar un ciclo, entonces nos interesa frecuencia máxima de 0.5 ciclos por unidad de tiempo.


 
## Comportamiento cíclico y periodicidad

- vamos a generalizar el modelo anterior a $q$ mezclas de series periódicas.

$$x_t=\sum_{k=1}^q U_{k1} cos(2\pi \omega_k t )+U_{k2} sin(2\pi \omega_k t ),$$
donde $U_{k1},U_{k2}$, para $k=1,...,q$ son v.a. con media cero con variancia $\sigma_k^2$ y no correlacionadas, y $\omega_k$ son frecuencias distintas.

- Se puede comprobar que 
$$\gamma_X(h)=\sum_{k=1}^q \sigma_k^2 cos(2 \pi \omega_k h).$$
- De esta forma, $x_t$ es estacionario con media $0$ y variancia $\gamma_X(0)=\sum_{k=1}^q \sigma_k^2$.

 
## Comportamiento cíclico y periodicidad

Ejemplo: 
- Considere

$$x_t=\sum_{k=1}^q U_{k1} cos(2\pi \omega_k t )+U_{k2} sin(2\pi \omega_k t )$$
con $q=3$

- Cada término está dado por:
$$x_{t1}= 2 cos(2\pi t 6/100)+3 sin(2\pi t 6/100)$$
$$x_{t2}= 4 cos(2\pi t 10/100)+5 sin(2\pi t 10/100)$$
$$x_{t3}= 6 cos(2\pi t 40/100)+7 sin(2\pi t 40/100)$$

- Interprete la frecuencia $\omega$ y el ciclo $1/\omega$ de cada componente.

 
## Comportamiento cíclico y periodicidad

```{r echo=FALSE, fig.align="center", out.width = "70%"}
x1 = 2*cos(2*pi*1:100*6/100)  + 3*sin(2*pi*1:100*6/100)
x2 = 4*cos(2*pi*1:100*10/100) + 5*sin(2*pi*1:100*10/100)
x3 = 6*cos(2*pi*1:100*40/100) + 7*sin(2*pi*1:100*40/100)
x = x1 + x2 + x3 

par(mfrow=c(2,2))
tsplot(x1, ylim=c(-10,10), main = expression(omega==6/100~~~A^2==13))
tsplot(x2, ylim=c(-10,10), main = expression(omega==10/100~~~A^2==41))
tsplot(x3, ylim=c(-10,10), main = expression(omega==40/100~~~A^2==85))
tsplot(x, ylim=c(-16,16), main="sum")
```

 
## Estimación y el periodograma

- Sea una serie temporal $x_1,...,x_T$ con $T$ impar. Se puede escribir $x_t$ como

$$x_t = a_0 + \sum_{j=1}^{(T-1)/2} \left[ a_j \cos(2\pi t~j/T)+b_j \sin(2\pi t~j/T) \right].$$
- Si $T$ es par, se puede modificar la ecuación sumando a $(T/2-1)$ y agregar un componente adicional por $a_{T/2} \cos(2\pi t~\frac{1}{2})=a_{T/2}(-1)^t$.

- Note que $a_0$, $a_j$ y $b_j$ son desconocidos y requieren ser estimados. Considerando como un modelo de regresión, los coeficientes pueden ser calculados por: $a_0=\bar{x}$

$$a_j=\frac{2}{T}\sum_{t=1}^T x_t \cos(2\pi t~j/T),~~~\text{y}~~~ b_j=\frac{2}{T}\sum_{t=1}^T x_t \sin(2\pi t~j/T)$$
 
## Estimación y el periodograma

- Los coeficientes $a_j$ y $b_j$ tienen el significado de cuán grande es la amplitud de cada componente de frecuencias $j/T$.

- Por consiguiente, podemos definir el **periodograma** como
$$P(j/T)=a_j^2+b_j^2,~ \text{para}~~ j=1,...,(T-1)/2$$
- Note que el periodograma expresa la serie temporal $x_t$ en sumas de los componentes de frecuencias (oscilación sinusoidal) multiplicado por su variancia $\sigma_j^2$.

- Valores altos de $P(j/T)$ implica que la contribución de la frecuencia $\omega_j=j/T$ es importante. Valores pequeños implica que son ruidos.


 
## Estimación y el periodograma

- En la práctica, es común enfrentar series largas y el uso computacional del enfoque de regresión no es eficiente.

- Se utiliza la **Transformada Discreta de Fourier (TDF)** que se discutirá con más detalles:

$$d(j/T)=\frac{1}{T^{1/2}}\sum_{t=1}^T x_t \exp{(-2 \pi it~j/T)}$$
$$= \frac{1}{T^{1/2}}\sum_{t=1}^T x_t \cos(2\pi t~j/T)- i \sum_{t=1}^T x_t \sin(2\pi t~j/T)$$

 
## Ejemplo simulado

- Recuerde que

$$x_t=\sum_{k=1}^3 U_{k1} cos(2\pi \omega_k t )+U_{k2} sin(2\pi \omega_k t )$$

- Cada término está dado por:
$$x_{t1}= 2 cos(2\pi t 6/100)+3 sin(2\pi t 6/100)$$
$$x_{t2}= 4 cos(2\pi t 10/100)+5 sin(2\pi t 10/100)$$
$$x_{t3}= 6 cos(2\pi t 40/100)+7 sin(2\pi t 40/100)$$


 
## Ejemplo simulado

```{r echo=FALSE, fig.align="center", out.width = "60%"}
x1 = 2*cos(2*pi*1:100*6/100)  + 3*sin(2*pi*1:100*6/100)
x2 = 4*cos(2*pi*1:100*10/100) + 5*sin(2*pi*1:100*10/100)
x3 = 6*cos(2*pi*1:100*40/100) + 7*sin(2*pi*1:100*40/100)
x = x1 + x2 + x3 

par(mfrow=c(2,2))
tsplot(x1, ylim=c(-10,10), main = expression(omega==6/100~~~A^2==13))
tsplot(x2, ylim=c(-10,10), main = expression(omega==10/100~~~A^2==41))
tsplot(x3, ylim=c(-10,10), main = expression(omega==40/100~~~A^2==85))
tsplot(x, ylim=c(-16,16), main="sum")
```

 
## Ejemplo simulado

```{r echo=FALSE, fig.align="center", out.width = "30%"}
P = abs(2*fft(x)/100)^2
Fr = 0:99/100                    
tsplot(Fr, P, type="o", xlab="frequency", ylab="periodogram")
abline(v=.5, lty=2)

```


- Note que:
$P\left(\frac{6}{100}\right)=P\left(\frac{94}{100}\right)=13$, $P\left(\frac{10}{100}\right)=P\left(\frac{90}{100}\right)=41$  
$P\left(\frac{40}{100}\right)=P\left(\frac{60}{100}\right)=85$  

- Si consideramos $x_t$ como un color (en forma de ondas), que está compuesto por 3 colores distintos con su intensidad (amplitud), podemos considerar el periodograma como un prisma que descompone el color $x_t$ en los colores primarios (espectro).

 
## Ejemplo: Magnitud de estrella

- Considere la serie temporal de la magnitud de una estrella a las 00:00 (medianoche) de 600 días consecutivos. Su gráfico y el periodograma de frecuencias menores que 0.08 se muestran a continuación.

```{r echo=FALSE, fig.align="center", out.width = "35%"}
n    = length(star)
par(mfrow=c(2,1))
tsplot(star, ylab="star magnitude", xlab="day")
Per   = Mod(fft(star-mean(star)))^2/n
Freq  = (1:n -1)/n
tsplot(Freq[1:50], Per[1:50], type='h', lwd=3, ylab="Periodogram", xlab="Frequency")
text(.05,  7000, "24 day cycle") 
text(.027, 9000, "29 day cycle")

```

- El periodograma muestra ciclos de 29 $(\approx 1/0.035)$ y 24  $(\approx 1/0.041)$ días.

- Esto ocurre debido a un ruido de observación de la frecuencia real $\omega \pm \delta$. Ver el ejemplo 4.3 de Shumway & Stoffer. La solución es usar periodograma suavizado.

 
## En la próxima clase veremos

**Representación espectral de procesos estacionarios.**

- Es necesario entender los fundamentos teóricos de los conceptos de frecuencia (poblacional) antes de entrar al caso cuando se tiene series observadas (muestral).

- Vamos a ver la definición de la densidad espectral y su relación con un proceso estacionario.

